<head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <style>
        .board {
            height: 500px;
            width: 500px;
            background-color: white;
            margin: auto;
        }

        .start {
            background-color: white;
            border: 1px solid blue;
            border-radius: 12px;
            margin-top: 5px;
            display: inline-block;
        }

        html {
            background-image: url("blue-stripes.gif");
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="board" class="board"></div>
    <button id="start" type="button" class="start" onclick="startGame()">Start</button>
    <script>
        $("#start").focus();

        let player1;
        let player2;
        let playerCount = 1;
        let turnCount = { 1: 0, 2: 0 };
        let waitingPress = { 1: null, 2: null };
        let history = {};

        function startGame() {
            $("#start").hide();
            listenForKeyDowns();
            player1 = new player("cyan");
            player2 = new player("magenta");
            const gameplay = setInterval(function () {
                if (turnCount[1] === 10) {
                    turnCount[1] = 0;
                    if (waitingPress[1]) {
                        keydownHandler(waitingPress[1]);
                        waitingPress[1] = null;
                    }
                }

                if (turnCount[2] === 10) {
                    turnCount[2] = 0;
                    if (waitingPress[2]) {
                        keydownHandler(waitingPress[2]);
                        waitingPress[2] = null;
                    }
                }
                let x = player1.x;
                let y = player1.y;
                let speed = player1.speed;
                let direction = player1.direction;
                player1.move();
                player1.leaveTrail(x, y, speed, player1.direction);
                turnCount[1] += player1.speed;

                x = player2.x;
                y = player2.y;
                speed = player2.speed;
                direction = player2.direction;
                player2.move();
                player2.leaveTrail(x, y, speed, player2.direction);
                turnCount[2] += player2.speed;

                if (crashed()) {
                    clearInterval(gameplay);
                    alert("CRASH BANG WALLOP, what a video.");
                    reset();
                }
            }, 10);
        }

        function listenForKeyDowns() {
            $(document).on("keydown", function (e) {
                keydownHandler(e);
            });
        }

        function keydownHandler(e) {
            switch (e.keyCode) {
                case 77:
                    if (turnCount[2] === 0) {
                        e.preventDefault();
                        if (player2.boosts > 0 && !player2.isBoosting) {
                            player2.isBoosting = true;
                            player2.boosts--;
                            player2.changeSpeed(2);
                        }
                    } else {
                        waitingPress[2] = e;
                    }
                    break;
                case 37:
                    if (turnCount[2] === 0) {
                        if (player2.direction.x != 1) {
                            player2.changeDirection({ x: -1, y: 0 });
                        }
                    } else {
                        waitingPress[2] = e;
                    }
                    break;
                case 38:
                    if (turnCount[2] === 0) {
                        if (player2.direction.y != 1) {
                            player2.changeDirection({ x: 0, y: -1 });
                        }
                    } else {
                        waitingPress[2] = e;
                    }
                    break;
                case 39:
                    if (turnCount[2] === 0) {
                        if (player2.direction.x != -1) {
                            player2.changeDirection({ x: 1, y: 0 });
                        }
                    } else {
                        waitingPress[2] = e;
                    }
                    break;
                case 40:
                    if (turnCount[2] === 0) {
                        if (player2.direction.y != -1) {
                            player2.changeDirection({ x: 0, y: 1 });
                        }
                    } else {
                        waitingPress[2] = e;
                    }
                    break;
                case 49:
                    if (turnCount[1] === 0) {
                        e.preventDefault();
                        if (player1.boosts > 0 && !player1.isBoosting) {
                            player1.isBoosting = true;
                            player1.boosts--;
                            player1.changeSpeed(2);
                        }
                    } else {
                        waitingPress[1] = e;
                    }
                    break;
                case 65:
                    if (turnCount[1] === 0) {
                        if (player1.direction.x != 1) {
                            player1.changeDirection({ x: -1, y: 0 });
                        }
                    } else {
                        waitingPress[1] = e;
                    }
                    break;
                case 87:
                    if (turnCount[1] === 0) {
                        if (player1.direction.y != 1) {
                            player1.changeDirection({ x: 0, y: -1 });
                        }
                    } else {
                        waitingPress[1] = e;
                    }
                    break;
                case 68:
                    if (turnCount[1] === 0) {
                        if (player1.direction.x != -1) {
                            player1.changeDirection({ x: 1, y: 0 });
                        }
                    } else {
                        waitingPress[1] = e;
                    }
                    break;
                case 83:
                    if (turnCount[1] === 0) {
                        if (player1.direction.y != -1) {
                            player1.changeDirection({ x: 0, y: 1 });
                        }
                    } else {
                        waitingPress[1] = e;
                    }
                    break;
            }
        }
        time = 40;
        function player(colour) {
            const boardPositions = getBoardPositions();
            this.x = boardPositions.left + time;
            time = 450;
            this.y = boardPositions.top + (boardPositions.bottom - boardPositions.top) / 2 - 10;
            this.colour = colour;
            this.direction = { x: 0, y: -1 };
            this.speed = 1;
            this.boosts = 3;
            this.isBoosting = false;
            this.id = "player_" + playerCount;
            this.boostCount = 0;
            this.noOfTrails = 0;
            this.previousDirection = this.direction;
            this.changeDirection = function (direction) {
                this.previousDirection = this.direction;
                this.direction = direction;
            };
            this.changeSpeed = function (speed) {
                this.speed = speed;
            };
            this.move = function () {
                history[this.x + "," + this.y] = true;
                this.x += this.direction.x * this.speed;
                this.y += this.direction.y * this.speed;
                $("#" + this.id)[0].style.left = this.x;
                $("#" + this.id)[0].style.top = this.y;
                if (this.isBoosting) {
                    const missedTrail = this.x - this.direction.x + "," + this.y - this.direction.y;
                    history[missedTrail] = true;
                    if (this.boostCount !== 100) {
                        this.boostCount++;
                    } else {
                        this.boostCount = 0;
                        this.isBoosting = false;
                        this.changeSpeed(1);
                    }
                }
            };
            this.leaveTrail = function (x, y, speed, direction) {
                let trail = document.getElementById(this.id + this.noOfTrails.toString());
                const seed = speed === 2 && turnCount !== 10 ? 1 : 0;
                if (this.previousDirection != direction || trail === null){
                    this.previousDirection = this.direction;
                    this.noOfTrails++;
                    trail = document.createElement("div");
                    trail.id = this.id + this.noOfTrails.toString();
                    trail.className = "trail";
                    trail.style.width = direction.x === 0 ? 10 : speed;
                    trail.style.height = direction.y === 0 ? 10 : speed;
                    if (direction.x === -1) trail.style.width = 10;
                    if (direction.y === -1) trail.style.height = 10;
                    trail.style.backgroundColor = colour;
                    trail.style.position = "absolute";
                    if (direction.y === -1) trail.style.top = y + 10; trail.style.left = x;
                    if (direction.y === 1) trail.style.top = y; trail.style.left = x;
                    if (direction.x === -1) trail.style.top = y; trail.style.left = x + 10;
                    if (direction.x === 1) trail.style.top = y; trail.style.left = x;
                    $("#board")[0].appendChild(trail);
                } else {
                    const currentWidth = parseInt(trail.style.width);
                    const currentHeight = parseInt(trail.style.height);
                    trail.style.width = direction.x === 0 ? 10 : speed + currentWidth;
                    trail.style.height = direction.y === 0 ? 10 : speed + currentHeight;
                    if (this.direction.x === -1) trail.style.left = x;
                    if (this.direction.x === 0) trail.style.left = x; 
                    if (this.direction.y === -1) trail.style.top = y;
                }
                
            }

            const playerIcon = document.createElement("div");
            playerIcon.id = this.id;
            playerIcon.style.width = 10;
            playerIcon.style.height = 10;
            playerIcon.style.backgroundColor = colour;
            playerIcon.style.position = "absolute";
            playerIcon.style.left = this.x;
            playerIcon.style.top = this.y;
            $("#board")[0].appendChild(playerIcon);
            playerCount += 2;
        }

        function crashed() {
            let crashed = false;

            if (playerCrashedIntoWall(player1) || playerCrashedIntoWall(player2)) {
                crashed = true;
            } else {
                const currentCoordinates1 = player1.x + "," + player1.y;
                const currentCoordinates2 = player2.x + "," + player2.y;
                if (history[currentCoordinates1] || history[currentCoordinates2]) {
                    crashed = true;
                }
            }

            return crashed;
        }

        function playerCrashedIntoWall(player) {
            const boardPositions = getBoardPositions();
            return player.x < boardPositions.left || (player.x + 10) > boardPositions.right || (player.y + 10) > boardPositions.bottom || player.y < boardPositions.top;
        }

        function getBoardPositions() {
            const result = {};
            const board = document.getElementById("board");
            result.top = board.offsetTop;
            result.bottom = board.offsetTop + board.offsetHeight;
            result.left = board.offsetLeft;
            result.right = board.offsetLeft + board.offsetWidth;
            return result;
        }

        function reset() {
            $("#board").empty();
            history = {};
            playerCount = 1;
            time = 40;
            $("#start").show();
            $("#start").focus();
        }
    </script>
</body>